# Top movie IDs: [49047, 975, 548, 96721, 902, 1955, 11878, 21575, 278, 238, 389, 3082, 346, 142061, 14784, 240, 637, 128, 191903, 81, 60243, 25376, 103663, 422, 175, 77338, 129, 20453, 8392, 10376, 51608, 155, 1891, 4935, 598, 582, 490, 11645, 146233, 553, 763, 804, 406, 550, 680, 11, 424, 101, 629, 510, 335, 613, 935, 11216, 10775, 914, 19, 13363, 696, 38142, 49797, 9277, 4808, 1278, 963, 22843, 985, 27205, 603, 122, 13, 54138, 807, 1892, 78, 429, 769, 670, 10515, 149, 7345, 24238, 765, 7347, 37797, 338, 703, 11113, 9394, 16, 9040, 9075, 8764, 120, 121, 497, 194, 38, 2493, 762, 641, 17431, 583, 16320, 567, 28178, 13310, 15, 9323, 31011, 1578, 387, 47931, 40662, 55, 212, 12140, 132344, 219, 1654, 979, 9571, 13989, 1592, 156700, 68718, 49026, 8587, 105, 857, 107, 274, 77, 115, 111, 500, 694, 73, 5915, 1542, 12429, 59440, 76, 138832, 3034, 80, 68, 923, 12104, 239, 12477, 11621, 11545, 638, 37495, 9474, 9008, 123025, 13001, 2323, 4584, 70667, 10925, 26466, 11901, 91586, 13342, 132363, 820, 10681, 13475, 98, 14160, 862, 10193, 16869, 197, 752, 89, 1422, 679, 100, 1417, 14756, 141, 138843, 600, 289, 28, 213, 1091, 947, 311, 11778, 104, 16859, 10331, 2292, 107985, 829, 793, 70670, 3175, 4977, 1443, 12225, 891, 1090, 86837, 69735, 8337, 378, 147773, 24428, 272, 585, 280, 85, 348, 75656, 1124, 745, 13223, 62, 64682, 539, 103, 2118, 275, 938, 10637, 10386, 1878, 1585, 14574, 423, 524, 33, 5723, 3176, 5925, 46838, 11202, 136400, 968, 984, 46146, 28874, 15196, 14534, 11371, 1700, 9289, 922, 2011, 37137, 43949, 77459, 15370, 58857, 522, 996, 11633, 5902, 34653, 15144, 1880, 1726, 12, 10191, 2501, 2503, 62211, 640, 185, 22538, 6977, 489, 782, 9509, 153, 2649, 207, 9470, 525, 134, 2108, 627, 10315, 279, 74643, 8321, 766, 13377, 2832, 872, 391, 2666, 421, 6844, 4538, 401, 473, 819, 9388, 14337, 1607, 2757, 794, 45132, 9462, 11647, 10377, 15137, 828, 4032, 60420, 1523, 9003, 9314, 9270, 19995, 20352, 22, 562, 8681, 11324, 812, 38757, 2502, 19908, 393, 45269, 11036, 37165, 63, 14, 1402, 12405, 51497, 19913, 578, 949, 68724, 9340, 50014, 747, 1640, 15472, 792, 11321, 12163, 853, 59859, 1018, 9473, 5825, 1427, 948, 117, 154, 252, 11978, 24253, 4553, 783, 9461, 11969, 5236, 4543, 9428, 9392, 10634, 94329, 192, 11836, 966, 74306, 6075, 43923, 51052, 903, 2295, 409, 1255, 36593, 967, 55347, 2332, 293, 87499, 10559, 10623, 22586, 10122, 14462, 68721, 87827, 597, 82690, 18785, 49538, 1271, 93456, 161, 36557, 18, 329, 23483, 72190, 2062, 24, 10020, 37799, 49519, 17654, 82695, 8358, 453, 1372, 9802, 10144, 44264, 9479, 60308, 137, 242, 1491, 70, 9693, 22803, 15121, 59436, 186, 1579, 136795, 199, 37472, 581, 235, 9475, 9495, 20766, 57212, 183011, 4133, 921, 8374, 51739, 164, 241, 12133, 168, 63311, 764, 76285, 10110, 8967, 11362, 39939, 334, 4771, 8923, 62215, 7549, 8469, 38199, 826, 55420, 72113, 167, 51162, 41233, 1498, 8051, 87825, 1587, 123553, 84329, 2196, 6615, 1946, 12914, 1621, 8470, 7304, 11635, 1389, 2322, 1985, 127517, 24684, 907, 5551, 6488, 9556, 9559, 526, 916, 7214, 10528, 674, 68734, 68726, 9806, 58574, 218, 1895, 808, 863, 64690, 2787, 187, 22881, 620, 45612, 4922, 45317, 109410, 162, 4638, 109414, 12162, 9552, 594, 1366, 84892, 23168, 2034, 1669, 380, 587, 7299, 11688, 2270, 4982, 755, 770, 77016, 658, 881, 97, 1933, 377, 6114, 926, 49018, 756, 13809, 184, 4348, 1832, 1272, 10229, 609, 9316, 13156, 665, 116, 49517, 10601, 51828, 64685, 6978, 319, 33613, 9366, 426, 8195, 4476, 18947, 193, 9675, 2330, 3432, 1541, 8963, 4995, 16290, 2293, 10045, 1381, 1429, 6145, 76025, 10950, 84332, 11977, 44865, 2670, 42188, 1677, 43959, 2616, 71, 68812, 71859, 10779, 103332, 82684, 1887, 37233, 9610, 10024, 43549, 8769, 11846, 59860, 9563, 38543, 9665, 10249, 504, 2899, 75900, 2334, 11009, 49051, 82693, 6479, 6479, 1858, 165, 87, 51876, 196, 601, 114150, 630, 568, 8363, 616, 170, 35, 9325, 9377, 1954, 10674, 5503, 13885, 628, 146, 388, 2109, 3933, 14836, 57214, 297, 1991, 1813, 4232, 824, 6023, 2756, 492, 322, 83666, 34584, 924, 3580, 1547, 470, 13597, 4347, 8741, 4147, 9016, 615, 11072, 871, 37094, 1265, 841, 4512, 7340, 9833, 10590, 37247, 46705, 2252, 8055, 612, 2288, 41402, 174, 814, 23169, 59, 13813, 68722, 622, 98567, 1251, 8193, 8872, 1281, 5, 1645, 9535, 7457, 8643, 43933, 10673, 10139, 4836, 57158, 2103, 11153, 119431, 10199, 84175, 8489, 11697, 9411, 11165, 1825, 67913, 451, 9086, 7450, 7450, 43947, 60307, 10529, 97365, 17134, 2064, 15655, 2655, 2755, 38843, 37724, 82992, 10138, 49521, 56292, 58, 607, 604, 285, 425, 9502, 1572, 76492, 65754, 81188, 49444, 50646, 44115, 855, 80278, 72976, 508, 4108, 861, 5176, 176, 1830, 1368, 8699, 40807, 23631, 2164, 10625, 1359, 4011, 1924, 1885, 773, 686, 142, 840, 1164, 9444, 5876, 1267, 10948, 37136, 9631, 10999, 205, 8329, 5038, 805, 1262, 9778, 8009, 8054, 571, 9454, 847, 1934, 243, 34813, 10428, 22907, 6312, 4488, 55931, 3509, 9837, 860, 4148, 11319, 9100, 9550, 10027, 182127, 8913, 76338, 15357, 9292, 119675, 6537, 8328, 3172, 11017, 17609, 2255, 9087, 13971, 11412, 22798, 11329, 34480, 12153, 2657, 45657, 11615, 65291, 11884, 26428, 36657, 39514, 83542, 61791, 36658, 44214, 277, 2048, 46195, 39254, 13183, 80321, 17578, 180, 158011, 771, 652, 97367, 268, 9798, 1824, 12244, 44826, 116711, 350, 563, 55721, 1597, 39513, 11886, 103731, 22947, 4951, 856, 3170, 117251, 2668, 927, 2024, 2253, 12092, 77174, 646, 7350, 657, 43539, 41216, 10198, 642, 5175, 1374, 11970, 1949, 433, 12113, 50348, 9472, 8619, 2898, 9614, 1992, 2300, 22972, 1367, 22954, 9362, 1089, 9361, 9387, 18487, 431, 786, 866, 813, 5123, 462, 8292, 9567, 201, 200, 2667, 8005, 8413, 157, 1103, 10830, 11439, 2609, 623, 2652, 9319, 1213, 1850, 9913, 10159, 11770, 29427, 4688, 978, 1911, 9800, 16538, 39013, 4234, 12144, 9603, 9671, 7445, 10851, 13532, 11596, 26390, 10647, 4643, 9942, 10303, 8999, 37950, 13179, 2335, 9667, 2067, 11548, 10047, 2179, 70160, 1771, 59967, 62177, 1865, 2080, 605, 76170, 82654, 13804, 954, 1571, 602, 1573, 49530, 2789, 298, 950, 9654, 8355, 44896, 163, 37735, 1576, 9737, 22970, 787, 38055, 9487, 2059, 941, 744, 754, 7326, 854, 51540, 134374, 11253, 1635, 114, 68727, 1948, 27582, 621, 109418, 1562, 72387, 82633, 44048, 1538, 36955, 90, 10895, 10189, 10530, 9741, 544, 4944, 12222, 8467, 65, 88, 50456, 2675, 112949, 11282, 65057, 14306, 62835, 26389, 1246, 345, 8848, 9659, 22971, 1371, 4349, 17979, 454, 31867, 5174, 69, 858, 13600, 4513, 8068, 639, 49520, 9762, 116741, 11003, 9291, 1907, 5994, 7552, 320, 2069, 115782, 9352, 26388, 79, 4824, 9359, 12159, 668, 2907, 6415, 15373, 2605, 11454, 22832, 36685, 5137, 11455, 61891, 11551, 16995, 16523, 9336, 25195, 12100, 35690, 2309, 10312, 1551, 11395, 11287, 1725, 8843, 22897, 9946, 6073, 9493, 12106, 75258, 12690, 1648, 9588, 8976, 10782, 37933, 28302, 11323, 4597, 38303, 9872, 12182, 10735, 2122, 801, 72431, 1930, 10195, 9799, 38356, 557, 72105, 64688, 920, 57800, 8373, 20526, 1894, 95, 20504, 109428, 9543, 834, 87421, 34544, 27576, 38050, 58423, 411, 3049, 408, 8961, 254, 561, 57201, 73723, 1577, 41733, 1637, 50546, 46529, 644, 364, 1701, 11224, 146216, 496, 8488, 37135, 11322, 10201, 9739, 7446, 5255, 7555, 11544, 23827, 818, 9602, 82507, 816, 1495, 9732, 62214, 72570, 10882, 796, 2123, 10112, 8367, 2280, 49021, 634, 1581, 43347, 55787, 75674, 865, 10545, 19901, 392, 41446, 788, 41283, 8271, 20943, 660, 72571, 9426, 2112, 72197, 10147, 864, 9326, 44249, 2289, 533, 77877, 34016, 1535, 245, 71688, 8810, 121824, 28211, 8346, 177888, 37056, 4437, 58151, 9820, 6278, 49494, 1268, 10567, 174772, 846, 74534, 22824, 4588, 1642, 8952, 13648, 1598, 9944, 11001, 11808, 913, 9433, 41515, 13460, 9023, 14001, 11358, 6435, 9276, 48838, 9963, 10072, 9007, 81025, 10589, 9882, 8409, 8388, 21407, 1266, 11852, 69798, 50321, 48572, 10061, 8338, 70981, 41154, 117263, 36668, 558, 953, 1893, 87502, 52520, 82682, 809, 97630, 49049, 36647, 2105, 591, 12437, 109421, 22794, 13053, 37686, 7737, 9615, 8065, 6957, 710, 7551, 7191, 39538, 12230, 18240, 58233, 77866, 3021, 1584, 879, 8844, 86838, 86825, 75174, 942, 1620, 10693, 9335, 49526, 693, 9078, 10591, 9522, 251, 41630, 9273, 10340, 3131, 7518, 36643, 2567, 10316, 7461, 565, 8273, 1903, 81796, 65086, 588, 85446, 509, 1817, 23742, 9032, 9313, 681, 7980, 68179, 152, 64328, 16577, 9481, 60935, 3563, 9477, 19898, 88042, 9373, 8536, 667, 12201, 11917, 9598, 32823, 4970, 10431, 6282, 2135, 41439, 87428, 768, 795, 4233, 9350, 1900, 3683, 55846, 55465, 9759, 10982, 4141, 6947, 65759, 2294, 9618, 9655, 231, 9896, 50839, 42297, 8922, 8840, 1729, 3989, 2085, 647, 74387, 951, 8856, 10664, 35019, 712, 2924, 1691, 11967, 16186, 10898, 8838, 139567, 9788, 70436, 75638, 4421, 9396, 4953, 150, 2758, 16781, 8204, 8277, 617, 1494, 9621, 9697, 1051, 2604, 9038, 83686, 80271, 75612, 75780, 12155, 10764, 1724, 109439, 564, 50620, 310, 49529, 956, 11452, 59961, 10527, 584, 38365, 10140, 132232, 9740, 76726, 1624, 20662, 32657, 13027, 9533, 13387, 48138, 34851, 943, 87826, 15092, 58244, 9532, 9870, 11360, 944, 77931, 4964, 1493, 74465, 11774, 49527, 9476, 21208, 1369, 9486, 8839, 4523, 402, 10719, 4547, 145135, 16871, 8916, 9390, 6466, 10009, 1574, 24420, 7484, 112336, 45772, 16866, 80389, 9919, 96, 682, 700, 88005, 58224, 16614, 25, 11459, 10865, 9374, 9595, 708, 11887, 9255, 1586, 8584, 9384, 151960, 1904, 9664, 38357, 11238, 60599, 4564, 10030, 4566, 38358, 11690, 28355, 9932, 9331, 63492, 10776, 22327, 13207, 28004, 172533, 9349, 11683, 12184, 1247, 152259, 9923, 10345, 14359, 11460, 7211, 9030, 3595, 15157, 9530, 10501, 45243, 76163, 27578, 82675, 330, 608, 72710, 71552, 49013, 76493, 13448, 8909, 35791, 10192, 810, 9339, 50544, 37710, 27581, 36648, 36586, 10483, 38575, 23629, 9705, 2454, 2770, 11665, 27022, 4247, 82525, 1656, 3594, 23048, 7443, 9772, 8871, 6972, 75, 2207, 2978, 9902, 215, 1690, 10358, 10313, 2022, 214, 9315, 13455, 4256, 27579, 9354, 82505, 1966, 2133, 22804, 7516, 928, 32985, 2026, 10439, 2277, 1647, 2005, 8224, 38408, 1273, 6795, 23759, 10204, 51620, 8274, 59678, 10153, 8874, 11529, 11247, 33217, 10585, 9874, 9312, 12403, 69668, 12233, 24803, 3293, 8275, 79548, 15159, 84348, 48340, 80038, 11968, 74998, 1852, 9641, 70578, 46503, 13515, 14873, 49040, 772, 9679, 435, 37834, 40805, 35056, 118, 8077, 15512, 7131, 676, 8078, 77950, 18360, 9928, 98357, 714, 1248, 664, 109491, 11631, 59108, 13811, 9489, 10555, 55779, 136418, 13335, 9506, 37821, 9398, 10184, 10137, 9029, 1738, 1370, 253, 11172, 707, 70435, 41436, 10679, 4248, 96724, 1844, 9355, 11430, 10330, 41210, 2791, 9297, 6038, 9906, 10663, 8452, 23082, 8007, 13836, 9801, 48171, 18480, 23172, 76494, 8845, 80585, 12096, 9792, 71864, 22821, 10033, 82650, 103620, 9718, 4959, 9036, 7459, 44982, 9869, 59861, 8978, 2082, 87496, 77875, 134597, 39781, 11096, 9884, 3050, 9691, 6519, 11931, 59968, 10160, 9992, 10708, 2119, 455, 9541, 8326, 14254, 9021, 10495, 9678, 50780, 64635, 14869, 109431, 559, 18823, 50619, 134411, 1734, 8960, 955, 57165, 6637, 24021, 59962, 1593, 107811, 74, 9342, 7451, 19959, 52451, 10096, 72545, 10661, 8698, 6557, 9286, 3981, 9982, 9358, 18501, 169, 8202, 77930, 11619, 8835, 9880, 72207, 2044, 38778, 691, 699, 1428, 1375, 172, 4257, 82990, 306, 9920, 9208, 2114, 11232, 2976, 10796, 11199, 8834, 11674, 10065, 57431, 10538, 6950, 72358, 36670, 7364, 13477, 4614, 4474, 10665, 24418, 48231, 68817, 11284, 6069, 9754, 26123, 11601, 2018, 13394, 806, 46261, 9437, 10074, 10488, 14161, 68728, 81005, 60304, 119283, 71679, 1995, 217, 331, 76640, 44943, 62213, 296, 72331, 9836, 41513, 5559, 39451, 173897, 10202, 36669, 37958, 2268, 9381, 869, 16996, 9257, 9471, 60747, 23047, 76617, 23437, 9408, 13051, 9397, 44040, 7220, 94348, 5966, 9285, 23398, 38117, 10947, 37707, 3597, 44564, 20048, 9620, 88794, 15969, 34806, 109513, 9383, 156717, 1970, 23023, 12620, 9637, 77883, 23514, 133694, 8859, 7303, 12090, 10014, 10040, 150202, 9600, 97614, 2752, 6964, 18405, 838, 13690, 82532, 11817, 12242, 72559, 58595, 8966, 44833, 1979, 1996, 49849, 18239, 89492, 102362, 52449, 7840, 64689, 27573, 37430, 2310, 139038, 49730, 38321, 47327, 49524, 9268, 19899, 698, 12556, 9482, 62838, 19585, 55301, 8390, 663, 62206, 9767, 144340, 87567, 11679, 9341, 49012, 10048, 13649, 9894, 9714, 81836, 18162, 57157, 184125, 84174, 9348, 9327, 14442, 127585, 126277, 8849, 1975, 9738, 44912, 82700, 158015, 395, 18911, 88751, 62764, 709, 9804, 59965, 19912, 32856, 1788, 8487, 10521, 440, 38745, 4442, 10054, 127493, 38319, 8814, 10022, 1636, 38317, 96936, 10032, 619, 50359, 13184, 77953, 44603, 61012, 93828, 82687, 38167, 150117, 6171, 54054, 9513, 135492, 11283, 9619, 82, 2043, 13056, 10066, 10336, 10761, 9279, 2157, 9353]

namespace :movies do
  desc 'Populate some movies!'
  task :populate => :environment do
    movie_ids = []

    api = ApiQuery.new
    (1..100).each do |page|
      puts "Fetching page #{page} of 100..."
      data = api.top_rated(page)
      data['results'].each { |movie| movie_ids << movie['id'] }
      sleep 0.25
    end

    puts "Top movie IDs: #{movie_ids.inspect}"

    movie_ids.each_with_index do |id, idx|
      puts "Fetching movie #{id} (#{idx + 1} of #{movie_ids.length})..."
      movie = api.movie(id)
      movie_record = Movie.find_or_create_by(external_id: movie['id']) do |record|
        record.title = movie['title']
        record.description = movie['overview']
        record.picture = movie['poster_path']
        record.year = movie['release_date'].present? ? movie['release_date'].split('-').first.to_i : nil
        record.budget = movie['budget'].present? ? movie['budget'].to_i : nil
      end

      (movie['genres'] || []).each do |genre|
        genre_record = Genre.find_or_create_by(external_id: genre['id']) do |record|
          record.name = genre['name']
        end

        Tagging.find_or_create_by(movie_id: movie_record.id, genre_id: genre_record.id)
      end

      casts = movie['casts'].presence || { 'cast' => [] }
      (casts['cast'] || []).each do |cast|
        actor_record = Actor.find_or_create_by(external_id: cast['id']) do |record|
          record.name = cast['name']
          record.picture = cast['profile_path']
        end

        Part.find_or_create_by(actor_id: actor_record.id, movie_id: movie_record.id)
      end
      sleep 0.5
    end
  end
end